---
title: "R Notebook"
output: html_notebook
---

In this version, NA are removed along with the data points. So it removes somes data points in both x and y axis.

```{r}

library(readxl);library(xcms);library(ncdf4);library(reshape2);library(tidyr);library(xcms);library(dplyr);library(ggplot2); library(ggrepel);library(gtools);library(tibble);library(readr);library(knitr);library(magrittr);library(pander);library(stringi);library(stringr); library(tidyverse);library(xlsx);library(IsoCorrectoR);library(cowplot);library(matrixStats);library(plyr)

pathExperimentFolder = "//home//mathieu//Documents//Data//MSinco//MSTFA//"
# Leave ExtendWindow as FALSE. Issue when it's true.
#MSinco_v2(pathExperimentFolder, savePlot=FALSE,mzd = 0.8)

# Default value for lb and rb are 0.1 (this can be changed here)
#MSinco_v2 <- function(pathExperimentFolder, savePlot = TRUE,baselineCorrection=TRUE,isoCor = TRUE, mzd= 0.5) {
#options(digits=3)
mzd=0.3
savePlot= TRUE
baselineCorrection = TRUE
isoCor = TRUE
# Create Results folder and copy the ParameterFile to that folder (to keep a copy)
if (dir.exists(paste(pathExperimentFolder,format(Sys.time(),"%d-%m-%y")," ","Results1",sep="")) == FALSE) {
folder = paste(pathExperimentFolder,format(Sys.time(),"%d-%m-%y")," ","Results1",sep="")
dir.create(folder,mode = "0777")    
dir.create(paste(folder,"//PLOTS",sep=""),mode = "0777")
file.copy(paste(pathExperimentFolder,"Parameters","//ParameterFile.xlsx",sep=""),folder)
file.copy(paste(pathExperimentFolder,"Parameters","//MoleculeFile.xlsx",sep=""),folder)
} else {
folder = paste(pathExperimentFolder,format(Sys.time(),"%d-%m-%y")," ","Results",max(as.numeric(gsub("Results","",str_extract(grep("Results*", list.files(pathExperimentFolder),value = TRUE),pattern = "Results[0-9]{1,4}")))) +1,sep="")
dir.create(folder,mode = "0777")
dir.create(paste(folder,"//PLOTS",sep=""),mode = "0777") 
file.copy(paste(pathExperimentFolder,"Parameters","//ParameterFile.xlsx",sep=""),folder)
file.copy(paste(pathExperimentFolder,"Parameters","//MoleculeFile.xlsx",sep=""),folder)
  }

# Set paths
ParameterFile <- read_excel(paste(pathExperimentFolder,"Parameters","//ParameterFile.xlsx",sep=""))
Netcdfs <- paste(pathExperimentFolder,"Netcdfs//",sep="") # where your netCDF files are
Results <- paste(folder,"//",sep="")

# Load Netcdfs files
rawData <- c()
for (i in seq_along(list.files(Netcdfs, full.names = TRUE,pattern = ".CDF$",ignore.case = TRUE))) {
 rawData <- c(rawData, readMSData(mixedsort(list.files(Netcdfs, full.names = TRUE,pattern = ".CDF$",ignore.case = TRUE))[i], mode = "onDisk"))
}

# Objects
integrals.array <- paste(rep("integrals.ls",length(rawData)),seq_along(rawData),sep="")
integrals.array2 <- paste(rep("integrals.df",length(rawData)),seq_along(rawData),sep="")


######################################

rtMatrix <- matrix(nrow=sum(ParameterFile[[5]],length(ParameterFile[[5]])),ncol=2)
mzMatrix <- matrix(nrow=sum(ParameterFile[[5]],length(ParameterFile[[5]])),ncol=2)
namesMatrix <- matrix(nrow=sum(ParameterFile[[5]],length(ParameterFile[[5]])),ncol=1)
namesMatrix2 <- matrix(nrow=sum(ParameterFile[[5]],length(ParameterFile[[5]])),ncol=1)
namesMatrix3 <- c()
k=0
for (a in seq_along(ParameterFile[[1]])) {
namesMatrix3 <- c(namesMatrix3, paste(unlist(strsplit(ParameterFile[[1]][a], split = " "))[1], as.numeric(unlist(strsplit(ParameterFile[[1]][a], split = " "))[2]) + seq_len(ParameterFile[[5]][a]+1)-1))
}
namesMatrix2[,1] <- namesMatrix3
#rep(unlist(strsplit(ParameterFile[[1]], split = " "))[1],ParameterFile[[5]]+1)

k=0
for (a in seq_along(ParameterFile[[1]])){
  for (i in 1:(ParameterFile[[5]][a]+1)) { # +1 to account for the M0 isotopomer
mzMatrix[k+i,1] <- (ParameterFile[[4]][a] + i -1 - mzd)
mzMatrix[k+i,2] <- (ParameterFile[[4]][a] + i -1 + mzd)

}
k=k+i
}

rtMatrix[,1] <- rep(ParameterFile[[2]],(ParameterFile[[5]]+1))*60 # RT low, # +1 to account for the M0 isotopomer
rtMatrix[,2] <- rep(ParameterFile[[3]],(ParameterFile[[5]]+1))*60 # RT high, # +1 to account for the M0 isotopomer
namesMatrix[,1] <-rep(ParameterFile[[1]], ParameterFile[[5]]+1)

myfunction <- function(b) {
# REMOVE NA VALUES in data
  if (all(is.na(mychr[b]@intensity)) == FALSE)  {
    data.frame(intensity = subset(mychr[b]@intensity,is.na(mychr[b]@intensity) == FALSE), rtime=subset(mychr[b]@rtime,is.na(mychr[b]@intensity) == FALSE), mass0= rep(round((mychr[b]@filterMz[1]+mychr[b]@filterMz[2])/2), length(subset(mychr[b]@rtime,is.na(mychr[b]@intensity)== FALSE))))
  } else {
  data.frame(intensity = rep(0,length(mychr[b]@rtime)), rtime=mychr[b]@rtime, mass0= rep(round((mychr[b]@filterMz[1]+mychr[b]@filterMz[2])/2), length(mychr[b]@intensity)))
}}

    for (j in seq_along(rawData)) {
  mychr <- chromatogram(rawData[[j]],rtMatrix,mzMatrix)
  extractData.ls <- lapply(seq_len(nrow(mychr)), FUN = myfunction) # list of data.frames
  extractData.ls2 <- extractData.ls
  names(extractData.ls) <- namesMatrix
  names(extractData.ls2) <- namesMatrix2
  extractData.df <- ldply(.data = extractData.ls, .fun = rbind())

predictions.ls2 <- list()
correctedIntensities4 <- list()

if (baselineCorrection == TRUE) { 

for (i in seq_along(namesMatrix)) {
  if (all(is.na(extractData.ls2[[i]]$intensity[1])) == FALSE) {
    
    rtWindow = data.frame(rtime = extractData.ls2[[i]]$rtime)
    leftScan = subset(extractData.ls2[[i]], is.na(intensity)==FALSE)[1,]
    rightScan = subset(extractData.ls2[[i]], is.na(intensity)==FALSE)[nrow(subset(extractData.ls2[[i]], is.na(intensity)==FALSE)),] # Instead of using only one value, we could do an AVERAGE intensity of multiple scan in each side of the integration window.
    modelData <- rbind(leftScan, rightScan)
    model <- lm(intensity ~ rtime, data = modelData) 
    #x <- extractData.ls2[[1]]$intensity
    #lm()
    #modelPoly2 <- lm(intensity ~ rtime, data = modelData) 
    #modelPoly <- lm(intensity ~ rtime, data = modelData) 
    prediction <- predict(model, newdata = rtWindow, type = "response")
    prediction2 <- data.frame(intensity=prediction,rtime=extractData.ls2[[i]]$rtime ,mass0=extractData.ls2[[i]]$mass0)
    predictions.ls <- list(prediction2)
    names(predictions.ls) <- namesMatrix[i] #names(extractData.ls2[i])
    predictions.ls2 <- append(predictions.ls2,predictions.ls)
    
    correctedIntensities <- data.frame(intensity = extractData.ls2[[i]]$intensity - prediction,rtime=extractData.ls2[[i]]$rtime ,mass0=extractData.ls2[[i]]$mass0)
    correctedIntensities$intensity[correctedIntensities$intensity < 0] <- 0 #removes negative values
    correctedIntensities3 <- list(correctedIntensities)
    names(correctedIntensities3) <- namesMatrix2[i]
    correctedIntensities4 <- append(correctedIntensities4,correctedIntensities3)
    
  } else {
    prediction <- 0 # data.frame(data.frame(intensity=0,rtime=extractData.ls2[[i]]$rtime,mass0=extractData.ls2[[i]]$mass0))
    predictions.ls <- list(data.frame(intensity=0,rtime=extractData.ls2[[i]]$rtime,mass0=extractData.ls2[[i]]$mass0))
    names(predictions.ls) <- namesMatrix[i] # names(extractData.ls2[i])
    predictions.ls2 <- append(predictions.ls2,predictions.ls)
    warning("No intensities were found at the the RT low parameter (NA). Baseline correction could not be applied. Please change the RT low parameter")
    
    correctedIntensities <- data.frame(intensity = extractData.ls2[[i]]$intensity - prediction,rtime=extractData.ls2[[i]]$rtime ,mass0=extractData.ls2[[i]]$mass0)
    #correctedIntensities$intensity[correctedIntensities$intensity < 0] <- 0 #removes negative values
    correctedIntensities3 <- list(correctedIntensities)
    names(correctedIntensities3) <- namesMatrix2[i]
    correctedIntensities4 <- append(correctedIntensities4,correctedIntensities3)
  }
}
predictions.df <- ldply(.data = predictions.ls2, .fun = rbind())
integrals.ls <- sapply(correctedIntensities4, function(x) sum2(x$intensity,na.rm = TRUE)) #sum(x$intensity)
# correctedIntensities4.df <- ldply(.data = correctedIntensities4, .fun = rbind()) #COULD PLOT THIS ONE AS WELL
integrals.df <- data.frame(namesMatrix2,integrals.ls, namesMatrix)
colnames(integrals.df) <- c("isotopomer",gsub(".CDF","",row.names(rawData[[j]]@phenoData)), "Subset")
assign(integrals.array2[j], integrals.df)
} else {

integrals.ls <- sapply(extractData.ls2, function(x) sum2(x$intensity,na.rm = TRUE)) #sum(x$intensity)
# correctedIntensities4.df <- ldply(.data = correctedIntensities4, .fun = rbind()) #COULD PLOT THIS ONE AS WELL
integrals.df <- data.frame(namesMatrix2,integrals.ls, namesMatrix)
colnames(integrals.df) <- c("isotopomer",gsub(".CDF","",row.names(rawData[[j]]@phenoData)), "Subset")
assign(integrals.array2[j], integrals.df)
  }

if (savePlot == TRUE & baselineCorrection ==TRUE) {
for (i in unique(namesMatrix)) {
    if (dir.exists(paste(folder,"//PLOTS//",i,sep="")) == FALSE) {
    dir.create(paste(folder,"//PLOTS//",i,sep=""),mode = "0777")
  }
  
ggplot() + geom_line(data = subset.data.frame(extractData.df, subset= extractData.df[,1] == i), mapping = aes(x=rtime/60, y=intensity,colour=factor(mass0))) + geom_line(data = subset.data.frame(predictions.df, subset= extractData.df[,1] == i), mapping = aes(x=rtime/60, y=intensity,colour=factor(mass0)),linetype="dashed",size=0.2) + labs(title = gsub(".CDF","",row.names(rawData[[j]]@phenoData)), x = "Time (min)", y = "Intensity", colour = paste0(sub(" .*", "", unique(subset.data.frame(extractData.df, subset= extractData.df[,1] == i)$.id))," m/z")) +
  theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16),
        axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 16),
        plot.title = element_text(size = 20, color = "Black")) + ggsave(paste(folder,"//PLOTS//",i,"//File_",gsub(".CDF","",row.names(rawData[[j]]@phenoData)),"_",i, ".png", sep=""))

}} else {
for (i in unique(namesMatrix)) {
    if (dir.exists(paste(folder,"//PLOTS//",i,sep="")) == FALSE) {
    dir.create(paste(folder,"//PLOTS//",i,sep=""),mode = "0777")
  }
  
ggplot() + geom_line(data = subset.data.frame(extractData.df, subset= extractData.df[,1] == i), mapping = aes(x=rtime/60, y=intensity,colour=factor(mass0))) + labs(title = gsub(".CDF","",row.names(rawData[[j]]@phenoData)), x = "Time (min)", y = "Intensity", colour = paste0(sub(" .*", "", unique(subset.data.frame(extractData.df, subset= extractData.df[,1] == i)$.id))," m/z")) +
  theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16),
        axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 16),
        plot.title = element_text(size = 20, color = "Black")) + ggsave(paste(folder,"//PLOTS//",i,"//File_",gsub(".CDF","",row.names(rawData[[j]]@phenoData)),"_",i, ".png", sep=""))

}
}
    }

mytable <- matrix()
for (i in unique(namesMatrix)) {
 for (x in seq_along(rawData)) {
  mytable <- cbind(mytable,subset.data.frame(get(integrals.array2[x]),subset = Subset == i,select = 2))
 }
   mytable2 <- mytable[-1]
   isotopomers <- paste(i,"_", 0:(nrow(mytable2)-1), sep = "")
   row.names(mytable2) <- isotopomers
   dir.create(paste(Results,i, sep = ""))
  
   write.xlsx(mytable2, file = paste(Results,i,"//",i,".xlsx", sep = ""))
   wb <- loadWorkbook(paste(Results,i,"//",i,".xlsx", sep = ""))
   sheets <- getSheets(wb)
   sheet <- sheets[[1]]  
   rows  <- getRows(sheet)  # get all the rows
   cells <- getCells(rows)
   setCellValue(cells[[1.2]], "Measurements/Samples")
   saveWorkbook(wb, paste(Results,i,"//",i,".xlsx", sep = ""))
   
    mytable <- matrix() #resets the matrix for the next iteration

    if(isoCor == TRUE) {
# Perform isotopic correction using isocorrectorR.
IsoCorrection(MeasurementFile=paste(Results,i,"//",i,".xlsx", sep = ""), ElementFile=paste(pathExperimentFolder,"Parameters//ElementFile.xlsx", sep=""), MoleculeFile= paste(pathExperimentFolder,"Parameters//MoleculeFile.xlsx",sep=""), DirOut=paste(Results,i,sep=""),FileOutFormat= "xls", FileOut = i,CorrectAlsoMonoisotopic = TRUE)
}

# Write some basic parameters used for the analysis
write.table(data.frame(mzd,baselineCorrection),file = paste0(folder,"/conf.txt"),row.names = FALSE,sep="\t")
  
#Rename folder # DEPRECATED
#xlsx_files <- dir(Results,pattern = ".xlsx")
#all_files <- dir(Results)
#folder_name <- setdiff(all_files,xlsx_files)
#file.rename(paste(Results,folder_name[1], sep = ""),paste(Results,i, sep = "")) #"_",folder_name[1], 

}
  #}

####################################
# j = seq_along(rawData)
# myfunction0bis <- function(j) {
#  for (j in seq_along(rawData)) {
  
 
#  mychr <- chromatogram(rawData[[j]],rtMatrix,mzMatrix)
#  extractData.ls <- lapply(seq_len(nrow(mychr)), FUN = myfunction) # list of data.frames
#names(extractData.ls) <- namesMatrix
#extractData.df <- ldply(.data = extractData.ls, .fun = rbind())

#  for (i in unique(namesMatrix)) {
  
#p <- ggplot(data = subset.data.frame(extractData.df, subset= extractData.df[,1] == i)) + geom_line(mapping = aes(x=rtime/60, #y=intensity,colour=factor(mass0))) + labs(title = "Temperatures\n", x = "Time (min)", y = "Intensity", colour = "Mass\n") +
#  theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16),
#        axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 16),
#        plot.title = element_text(size = 20, color = "Black")) + ggsave(paste(folder,"//PLOTS//","File_",row.names(rawData[[j]]@phenoData),"_",i, ".png", sep=""))
#}
#}}

#lapply(rawData, FUN = myfunction0)

####################################
#od <- options(digits = 3) # avoid too much visual clutter
#(z <- poly(1:10, 3))
#predict(z, seq(2, 4, 0.5))

```


